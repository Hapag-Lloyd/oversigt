<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WorldMapEventSource.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Oversigt Core</a> &gt; <a href="index.source.html" class="el_package">com.hlag.oversigt.sources</a> &gt; <span class="el_source">WorldMapEventSource.java</span></div><h1>WorldMapEventSource.java</h1><pre class="source lang-java linenums">package com.hlag.oversigt.sources;

import java.sql.Connection;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.Collection;
import java.util.Optional;
import java.util.stream.Collectors;

import javax.validation.constraints.NotNull;

import com.fasterxml.jackson.annotation.JsonCreator;
import com.fasterxml.jackson.annotation.JsonProperty;
import com.google.common.base.Strings;
import com.hlag.oversigt.connect.db.DatabaseCache;
import com.hlag.oversigt.core.eventsource.EventSource;
import com.hlag.oversigt.core.eventsource.Property;
import com.hlag.oversigt.properties.Color;
import com.hlag.oversigt.sources.data.JsonHint;
import com.hlag.oversigt.sources.data.JsonHint.ArrayStyle;
import com.hlag.oversigt.sources.event.MapEvent;
import com.hlag.oversigt.sources.event.MapEvent.Point;

import de.larssh.utils.Nullables;

@EventSource(displayName = &quot;World Map&quot;, view = &quot;Worldmap&quot;, hiddenDataItems = { &quot;updated-at-message&quot; })
public class WorldMapEventSource extends AbstractCachingJdbcEventSource&lt;Point, MapEvent&gt; {
<span class="nc" id="L28">	private String query = &quot;SELECT ID_NUMBER, LATITUDE, LONGITUDE, TYPE\r\n&quot; + &quot;FROM table\r\n&quot; + &quot;WHERE condition = 1&quot;;</span>

<span class="nc" id="L30">	private TypeMapping[] typeMappings = new TypeMapping[] {</span>
<span class="nc" id="L31">			new TypeMapping(&quot;TYPE&quot;, &quot;type-a&quot;, Color.parse(&quot;#e75200&quot;), Color.WHITE, 6.0),</span>
<span class="nc" id="L32">			new TypeMapping(&quot;TYPE&quot;, &quot;type-b&quot;, Color.parse(&quot;#0dc92c&quot;), Color.WHITE, 5.0) };</span>

<span class="nc" id="L34">	public WorldMapEventSource() {</span>
		// no fields to be initialized
<span class="nc" id="L36">	}</span>

	@Override
	protected DatabaseCache&lt;Point&gt; createCache() {
<span class="nc" id="L40">		return DatabaseCache.createCache(this::readShipPositions);</span>
	}

	private Collection&lt;Point&gt; readShipPositions(final Connection connection) throws SQLException {
<span class="nc" id="L44">		return readFromDatabase(connection, this::readPoint, getQuery());</span>
	}

	private Point readPoint(final ResultSet rs) throws SQLException {
<span class="nc" id="L48">		final String id = rs.getString(&quot;ID_NUMBER&quot;);</span>
<span class="nc" id="L49">		final double dlong = rs.getDouble(&quot;LONGITUDE&quot;);</span>
<span class="nc" id="L50">		final double dlat = rs.getDouble(&quot;LATITUDE&quot;);</span>
<span class="nc" id="L51">		TypeMapping mapping = null;</span>
<span class="nc bnc" id="L52" title="All 2 branches missed.">		for (final TypeMapping tm : getTypeMappings()) {</span>
<span class="nc" id="L53">			final String dbValue = Strings.nullToEmpty(rs.getString(tm.field)).trim();</span>
<span class="nc bnc" id="L54" title="All 2 branches missed.">			if (Strings.nullToEmpty(tm.value).equals(dbValue)) {</span>
<span class="nc" id="L55">				mapping = tm;</span>
<span class="nc" id="L56">				break;</span>
			}
		}
<span class="nc bnc" id="L59" title="All 2 branches missed.">		if (mapping == null) {</span>
<span class="nc" id="L60">			return new Point(id, dlong, dlat);</span>
		}
<span class="nc" id="L62">		return new Point(id, dlong, dlat, mapping.fill, mapping.stroke, mapping.size);</span>
	}

	@Property(name = &quot;Query&quot;,
			description = &quot;The query used to read position information. The result must contain three columns: ID_NUMBER, LONGITUDE, LATITUDE. Each point will be identified by the ID_NUMBER. Once an ID_NUMBER is known the point belonging to it will be moved with every subsequent call. If the latest query result does not contain a record with the respective ID_NUMBER the point will be removed from the map. Additional columns can be used to use the type mappings e.g. for different colors of the single points.&quot;,
			type = &quot;sql&quot;)
	public String getQuery() {
<span class="nc" id="L69">		return query;</span>
	}

	public void setQuery(final String query) {
<span class="nc" id="L73">		this.query = query;</span>
<span class="nc" id="L74">	}</span>

	@Property(name = &quot;Type Mappings&quot;, description = &quot;Change the color (type) of a point based on column values&quot;)
	public TypeMapping[] getTypeMappings() {
<span class="nc" id="L78">		return Nullables.orElseGet(typeMappings, () -&gt; new TypeMapping[0]);</span>
	}

	public void setTypeMappings(final TypeMapping[] typeMappings) {
<span class="nc" id="L82">		this.typeMappings = typeMappings;</span>
<span class="nc" id="L83">	}</span>

	@Override
	protected Optional&lt;MapEvent&gt; produceEventFromData() {
<span class="nc" id="L87">		return Optional.of(new MapEvent(stream().collect(Collectors.toList())));</span>
	}

	@JsonHint(arrayStyle = ArrayStyle.TABS, headerTemplate = &quot;Mapping {{i1}}&quot;)
	public static class TypeMapping {
		@NotNull
		private final String field;

		@NotNull
		private final String value;

		@NotNull
		private final Color fill;

		@NotNull
		private final Color stroke;

		@NotNull
		private final double size;

		@JsonCreator
		public TypeMapping(@JsonProperty(&quot;field&quot;) final String field,
				@JsonProperty(&quot;value&quot;) final String value,
				@JsonProperty(&quot;fill&quot;) final Color fill,
				@JsonProperty(&quot;stroke&quot;) final Color stroke,
<span class="nc" id="L112">				@JsonProperty(&quot;size&quot;) final double size) {</span>
<span class="nc" id="L113">			this.field = field;</span>
<span class="nc" id="L114">			this.value = value;</span>
<span class="nc" id="L115">			this.fill = fill;</span>
<span class="nc" id="L116">			this.stroke = stroke;</span>
<span class="nc" id="L117">			this.size = size;</span>
<span class="nc" id="L118">		}</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>