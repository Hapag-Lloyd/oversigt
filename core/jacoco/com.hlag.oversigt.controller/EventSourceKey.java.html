<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EventSourceKey.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Oversigt Core</a> &gt; <a href="index.source.html" class="el_package">com.hlag.oversigt.controller</a> &gt; <span class="el_source">EventSourceKey.java</span></div><h1>EventSourceKey.java</h1><pre class="source lang-java linenums">package com.hlag.oversigt.controller;

import static com.hlag.oversigt.util.ClassRenameDetector.detectComplexRename;
import static com.hlag.oversigt.util.ClassRenameDetector.detectPackageMove;
import static com.hlag.oversigt.util.ClassRenameDetector.detectSimpleRename;

import java.util.Collections;
import java.util.Comparator;
import java.util.HashMap;
import java.util.Map;
import java.util.Optional;
import java.util.concurrent.atomic.AtomicReference;

import javax.validation.constraints.NotNull;

import com.google.common.base.Strings;
import com.hlag.oversigt.core.eventsource.EventSource;
import com.hlag.oversigt.util.Utils;

import de.larssh.utils.Finals;
import edu.umd.cs.findbugs.annotations.Nullable;

public final class EventSourceKey implements Comparable&lt;EventSourceKey&gt; {
<span class="nc" id="L24">	private static final Comparator&lt;EventSourceKey&gt; COMPARATOR_BY_KEY</span>
<span class="nc" id="L25">			= Utils.caseSensitiveComparator(EventSourceKey::getKey);</span>

<span class="nc" id="L27">	private static AtomicReference&lt;EventSourceRenamer&gt; eventSourceRenamer = new AtomicReference&lt;&gt;();</span>

<span class="nc" id="L29">	static final String PREFIX_CLASS = Finals.constant(&quot;class:&quot;);</span>

<span class="nc" id="L31">	static final String PREFIX_WIDGET = Finals.constant(&quot;widget:&quot;);</span>

<span class="nc" id="L33">	private static final Map&lt;String, EventSourceKey&gt; KEYS = Collections.synchronizedMap(new HashMap&lt;&gt;());</span>

	static void setEventSourceRenamer(final EventSourceRenamer eventSourceRenamer) {
<span class="nc" id="L36">		EventSourceKey.eventSourceRenamer.set(eventSourceRenamer);</span>
<span class="nc" id="L37">	}</span>

	private static EventSourceKey findKeyFromClass(final String className) {
<span class="nc" id="L40">		Optional&lt;EventSourceKey&gt; key = detectPackageMove(KEYS, className);</span>
<span class="nc bnc" id="L41" title="All 2 branches missed.">		if (!key.isPresent()) {</span>
<span class="nc" id="L42">			key = detectSimpleRename(KEYS, className);</span>
		}
<span class="nc bnc" id="L44" title="All 2 branches missed.">		if (!key.isPresent()) {</span>
<span class="nc" id="L45">			key = detectComplexRename(KEYS, className);</span>
		}
<span class="nc" id="L47">		return key.orElseThrow(() -&gt; new RuntimeException(&quot;Unable to find matching class for: &quot; + className));</span>
	}

	private static EventSourceKey findKeyFromWidget(final String widget) {
		// TODO detect widget renamings
<span class="nc" id="L52">		throw new RuntimeException(&quot;Unknown widget id: &quot; + widget);</span>
	}

	public static EventSourceKey fromKeyString(final String key) {
<span class="nc bnc" id="L56" title="All 2 branches missed.">		if (!KEYS.containsKey(key)) {</span>
<span class="nc" id="L57">			final String type = getType(key);</span>
<span class="nc" id="L58">			final String subKey = getSubKey(key);</span>
<span class="nc bnc" id="L59" title="All 3 branches missed.">			switch (type) {</span>
			case &quot;class&quot;:
<span class="nc" id="L61">				final EventSourceKey newKey = findKeyFromClass(subKey);</span>
<span class="nc" id="L62">				Optional.ofNullable(eventSourceRenamer.get())</span>
<span class="nc" id="L63">						.ifPresent(r -&gt; r.changeEventSourceName(subKey, getSubKey(newKey.getKey())));</span>
<span class="nc" id="L64">				return newKey;</span>
			case &quot;widget&quot;:
<span class="nc" id="L66">				return findKeyFromWidget(subKey);</span>
			default:
<span class="nc" id="L68">				throw new InvalidKeyException(&quot;Unknown EventSourceKey type: &quot; + type);</span>
			}
		}
<span class="nc" id="L71">		return KEYS.get(key);</span>
	}

	public static EventSourceKey fromClassOrView(final Optional&lt;String&gt; className, final String viewName) {
<span class="nc" id="L75">		final String key = className.map(name -&gt; PREFIX_CLASS + name).orElseGet(() -&gt; PREFIX_WIDGET + viewName);</span>
<span class="nc" id="L76">		return fromKeyString(key);</span>
	}

	static EventSourceKey createKeyFromClass(final Class&lt;?&gt; clazz) {
<span class="nc" id="L80">		final String displayName = Optional.of(clazz.getAnnotation(EventSource.class))</span>
<span class="nc" id="L81">				.map(EventSource::displayName)</span>
<span class="nc" id="L82">				.map(Strings::emptyToNull)</span>
<span class="nc" id="L83">				.orElse(clazz.getSimpleName());</span>
<span class="nc" id="L84">		return addKey(new EventSourceKey(&quot;class:&quot; + clazz.getName(), displayName));</span>
	}

	static EventSourceKey createKeyFromWidget(final String widgetName, final String displayName) {
<span class="nc" id="L88">		return addKey(new EventSourceKey(&quot;widget:&quot; + widgetName, Strings.nullToEmpty(displayName)));</span>
	}

	private static EventSourceKey addKey(final EventSourceKey key) {
<span class="nc bnc" id="L92" title="All 2 branches missed.">		if (KEYS.containsKey(key.getKey())) {</span>
<span class="nc" id="L93">			throw new RuntimeException(&quot;Duplicate key: &quot; + key);</span>
		}
<span class="nc" id="L95">		KEYS.put(key.getKey(), key);</span>
<span class="nc" id="L96">		return key;</span>
	}

	private final String key;

	private final String displayName;

<span class="nc" id="L103">	private EventSourceKey(final String key, final String displayName) {</span>
<span class="nc" id="L104">		this.key = key;</span>
<span class="nc" id="L105">		this.displayName = displayName;</span>
<span class="nc" id="L106">	}</span>

	@NotNull
	public String getDisplayName() {
<span class="nc" id="L110">		return displayName;</span>
	}

	@NotNull
	public String getKey() {
<span class="nc" id="L115">		return key;</span>
	}

	private static String getType(final String key) {
<span class="nc" id="L119">		return key.substring(0, key.indexOf(&quot;:&quot;));</span>
	}

	private static String getSubKey(final String key) {
<span class="nc" id="L123">		return key.substring(key.indexOf(&quot;:&quot;) + 1);</span>
	}

	@Override
	public int hashCode() {
<span class="nc" id="L128">		final int prime = 31;</span>
<span class="nc" id="L129">		int result = 1;</span>
<span class="nc" id="L130">		result = prime * result + key.hashCode();</span>
<span class="nc" id="L131">		return result;</span>
	}

	@Override
	public boolean equals(@Nullable final Object obj) {
<span class="nc bnc" id="L136" title="All 2 branches missed.">		if (this == obj) {</span>
<span class="nc" id="L137">			return true;</span>
		}
<span class="nc bnc" id="L139" title="All 2 branches missed.">		if (obj == null) {</span>
<span class="nc" id="L140">			return false;</span>
		}
<span class="nc bnc" id="L142" title="All 2 branches missed.">		if (obj instanceof String) {</span>
<span class="nc" id="L143">			return key.equals(obj);</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">		} else if (getClass() != obj.getClass()) {</span>
<span class="nc" id="L145">			return false;</span>
		}
<span class="nc" id="L147">		final EventSourceKey other = (EventSourceKey) obj;</span>
<span class="nc" id="L148">		return key.equals(other.key);</span>
	}

	@Override
	public int compareTo(@Nullable final EventSourceKey that) {
<span class="nc" id="L153">		return COMPARATOR_BY_KEY.compare(this, that);</span>
	}

	@Override
	public String toString() {
<span class="nc" id="L158">		return key;</span>
	}

	@FunctionalInterface
	interface EventSourceRenamer {
		void changeEventSourceName(String oldName, String newName);
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>