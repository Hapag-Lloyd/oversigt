<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>HttpHandlers.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Oversigt Core</a> &gt; <a href="index.source.html" class="el_package">com.hlag.oversigt.core</a> &gt; <span class="el_source">HttpHandlers.java</span></div><h1>HttpHandlers.java</h1><pre class="source lang-java linenums">package com.hlag.oversigt.core;

import static com.hlag.oversigt.core.event.EventSender.DASHBOARD_KEY;
import static com.hlag.oversigt.util.HttpUtils.redirect;
import static com.hlag.oversigt.util.StringUtils.substringBefore;
import static com.hlag.oversigt.util.Utils.map;
import static de.larssh.utils.Finals.constant;
import static io.undertow.servlet.Servlets.defaultContainer;
import static io.undertow.servlet.Servlets.listener;
import static io.undertow.servlet.Servlets.servlet;
import static java.util.stream.Collectors.toList;

import java.io.IOException;
import java.io.StringWriter;
import java.net.URL;
import java.nio.ByteBuffer;
import java.nio.charset.Charset;
import java.nio.charset.StandardCharsets;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.security.Principal;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.Comparator;
import java.util.Deque;
import java.util.List;
import java.util.Map;
import java.util.NoSuchElementException;
import java.util.Objects;
import java.util.Optional;
import java.util.function.Function;
import java.util.function.Predicate;
import java.util.function.Supplier;
import java.util.stream.Collectors;
import java.util.stream.Stream;

import javax.servlet.DispatcherType;
import javax.servlet.ServletException;
import javax.ws.rs.core.Application;

import org.apache.commons.io.IOUtils;
import org.jboss.resteasy.cdi.CdiInjectorFactory;
import org.jboss.resteasy.core.ResteasyDeploymentImpl;
import org.jboss.resteasy.plugins.server.servlet.HttpServlet30Dispatcher;
import org.jboss.resteasy.spi.ResteasyDeployment;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import com.google.common.base.Ascii;
import com.google.common.base.Strings;
import com.google.common.eventbus.EventBus;
import com.google.common.io.Resources;
import com.google.inject.Inject;
import com.google.inject.Injector;
import com.google.inject.Singleton;
import com.google.inject.name.Named;
import com.hlag.oversigt.controller.DashboardController;
import com.hlag.oversigt.controller.DashboardDesignHelper;
import com.hlag.oversigt.controller.EventSourceInstanceController;
import com.hlag.oversigt.core.configuration.WroManagerFactory;
import com.hlag.oversigt.core.configuration.WroManagerFactory.CustomWroConfiguration;
import com.hlag.oversigt.core.configuration.WroManagerFactory.WroGroupContent;
import com.hlag.oversigt.core.event.JsonEvent;
import com.hlag.oversigt.model.Dashboard;
import com.hlag.oversigt.model.Widget;
import com.hlag.oversigt.properties.SerializableProperty;
import com.hlag.oversigt.security.Authenticator;
import com.hlag.oversigt.util.ClassPathResourceManager;
import com.hlag.oversigt.util.FileUtils;
import com.hlag.oversigt.util.HttpUtils;
import com.hlag.oversigt.util.JsonUtils;
import com.hlag.oversigt.util.TypeUtils;
import com.hlag.oversigt.web.api.ApiBootstrapListener;
import com.hlag.oversigt.web.ui.OversigtUiHelper;

import de.larssh.utils.Finals;
import de.larssh.utils.Nullables;
import freemarker.template.Configuration;
import freemarker.template.TemplateException;
import io.undertow.Handlers;
import io.undertow.security.api.AuthenticationMechanism;
import io.undertow.security.api.AuthenticationMode;
import io.undertow.security.api.SecurityContext;
import io.undertow.security.handlers.AuthenticationCallHandler;
import io.undertow.security.handlers.AuthenticationConstraintHandler;
import io.undertow.security.handlers.AuthenticationMechanismsHandler;
import io.undertow.security.handlers.SecurityInitialHandler;
import io.undertow.security.idm.Account;
import io.undertow.security.idm.IdentityManager;
import io.undertow.security.impl.BasicAuthenticationMechanism;
import io.undertow.server.HttpHandler;
import io.undertow.server.HttpServerExchange;
import io.undertow.server.handlers.BlockingHandler;
import io.undertow.server.handlers.sse.ServerSentEventConnection;
import io.undertow.server.handlers.sse.ServerSentEventHandler;
import io.undertow.servlet.Servlets;
import io.undertow.servlet.api.DeploymentInfo;
import io.undertow.servlet.api.DeploymentManager;
import io.undertow.servlet.api.InstanceFactory;
import io.undertow.servlet.api.ServletInfo;
import io.undertow.servlet.util.ImmediateInstanceHandle;
import io.undertow.util.HeaderMap;
import io.undertow.util.HeaderValues;
import io.undertow.util.Headers;
import io.undertow.util.HttpString;
import io.undertow.util.StatusCodes;
import ro.isdc.wro.http.ConfigurableWroFilter;

@Singleton
public class HttpHandlers {
<span class="nc" id="L113">	private static final Logger LOGGER = LoggerFactory.getLogger(HttpHandlers.class);</span>

<span class="nc" id="L115">	public static final String MAPPING_API = constant(&quot;/api/v1&quot;);</span>

	@Inject
	private Injector injector;

	@Inject
	private EventBus eventBus;

	@Inject
	private Configuration templateConfiguration;

	@Inject
	private DashboardController dashboardController;

	@Inject
	private EventSourceInstanceController instanceController;

	@Inject
	private IdentityManager identityManager;

	@Inject
	private Authenticator authenticator;

	@Inject
	@Named(&quot;widgetsPaths&quot;)
	private String[] widgetsPaths;

	@Inject
	@Named(&quot;showOwnersInWelcomePage&quot;)
	private boolean showOwnersInWelcomePage;

	@Inject
	@Named(&quot;foreignEvents.needAuthentication&quot;)
	private boolean foreignEventsNeedAuthentication;

	@Inject
	@Named(&quot;foreignEvents.apiKeyHeaderName&quot;)
	private String foreignEventsApiKeyHeaderName;

	@Inject
	@Named(&quot;foreignEvents.allowedApiKeys&quot;)
	private List&lt;String&gt; foreignEventsAllowedApiKeys;

	@Inject
	private Application restApiApplication;

<span class="nc" id="L161">	public HttpHandlers() {</span>
		// nothing to do
<span class="nc" id="L163">	}</span>

<span class="nc" id="L165">	private final Supplier&lt;ServerSentEventHandler&gt; serverSentEventHandlerSupplier</span>
<span class="nc" id="L166">			= Finals.lazy(this::createServerSentEventHandler);</span>

	ServerSentEventHandler getServerSentEventsHandler() {
<span class="nc" id="L169">		return serverSentEventHandlerSupplier.get();</span>
	}

	private ServerSentEventHandler createServerSentEventHandler() {
<span class="nc" id="L173">		return Handlers.serverSentEvents((final ServerSentEventConnection connection, final String lastEventId) -&gt; {</span>
<span class="nc" id="L174">			Optional.ofNullable(connection.getQueryParameters().get(&quot;dashboard&quot;))//</span>
<span class="nc" id="L175">					.map(Deque::getFirst)</span>
<span class="nc" id="L176">					.flatMap(dashboardController::getDashboard)</span>
<span class="nc" id="L177">					.ifPresent(dashboard -&gt; connection.putAttachment(DASHBOARD_KEY, dashboard));</span>
<span class="nc" id="L178">			eventBus.post(connection);</span>
<span class="nc" id="L179">		});</span>
	}

	HttpHandler createDashboardHandler() {
<span class="nc" id="L183">		return this::serveDashboard;</span>
	}

	private void serveDashboard(final HttpServerExchange exchange) throws Exception {
<span class="nc" id="L187">		final boolean searchHtml = Optional.ofNullable(exchange.getRequestHeaders().get(Headers.ACCEPT))</span>
<span class="nc" id="L188">				.map(Object::toString)</span>
<span class="nc" id="L189">				.map(Ascii::toLowerCase)</span>
<span class="nc" id="L190">				.map(s -&gt; s.contains(&quot;html&quot;))</span>
<span class="nc" id="L191">				.orElse(true);</span>

		// Check if request wants to download some asset of a widget
<span class="nc bnc" id="L194" title="All 2 branches missed.">		if (!searchHtml) {</span>
<span class="nc" id="L195">			redirect(exchange, &quot;/assets&quot; + exchange.getRequestURI(), false, true);</span>
<span class="nc" id="L196">			return;</span>
		}

		// check whether to serve a favicon
<span class="nc" id="L200">		final String dashboardId = exchange.getQueryParameters().get(&quot;dashboard&quot;).poll();</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">		if (&quot;favicon.ico&quot;.equals(dashboardId)) {</span>
<span class="nc" id="L202">			exchange.getResponseHeaders().add(HttpString.tryFromString(&quot;Content-Type&quot;), &quot;image/x-icon&quot;);</span>
<span class="nc" id="L203">			exchange.getResponseSender()</span>
<span class="nc" id="L204">					.send(ByteBuffer.wrap(Files.readAllBytes(</span>
<span class="nc" id="L205">							Paths.get(Resources.getResource(&quot;statics/assets/images/favicon.ico&quot;).toURI()))));</span>
<span class="nc" id="L206">			return;</span>
		}

		// check if the URI is correct... otherwise redirect to proper dashboard URI
<span class="nc" id="L210">		final String correctUri = &quot;/&quot; + dashboardId;</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">		if (!correctUri.equals(exchange.getRequestURI())) {</span>
<span class="nc" id="L212">			redirect(exchange, correctUri, true, true);</span>
<span class="nc" id="L213">			return;</span>
		}

		// check if dashboard is present and enabled
<span class="nc" id="L217">		final Optional&lt;Dashboard&gt; dashboard = dashboardController.getDashboard(dashboardId);</span>
<span class="nc bnc" id="L218" title="All 4 branches missed.">		if (!dashboard.isPresent() || !dashboard.get().isEnabled()) {</span>
<span class="nc" id="L219">			redirect(exchange, &quot;/config/dashboards/create/&quot; + dashboardId, false, true);</span>
<span class="nc" id="L220">			return;</span>
		}

		// actually serve the dashboard
<span class="nc" id="L224">		final String html = processTemplate(&quot;/web-templates/layout/dashboard/instance.ftl.html&quot;,</span>
<span class="nc" id="L225">				map(&quot;title&quot;,</span>
<span class="nc" id="L226">						dashboard.get().getTitle(),</span>
						&quot;columns&quot;,
<span class="nc" id="L228">						dashboard.get().getColumns(),</span>
						&quot;backgroundColor&quot;,
<span class="nc" id="L230">						dashboard.get().getBackgroundColor().getHexColor(),</span>
						&quot;computedTileWidth&quot;,
<span class="nc" id="L232">						dashboard.get().getComputedTileWidth(),</span>
						&quot;computedTileHeight&quot;,
<span class="nc" id="L234">						dashboard.get().getComputedTileHeight(),</span>
						&quot;widgets&quot;,
<span class="nc" id="L236">						dashboard.get().getWidgets(),</span>
						&quot;getWidgetDisplayStyle&quot;,
						(Function&lt;Widget, String&gt;) DashboardDesignHelper::getDisplayStyle,
						&quot;getWidgetDisplayClass&quot;,
						(Function&lt;Widget, String&gt;) DashboardDesignHelper::getDisplayClass));

<span class="nc" id="L242">		exchange.getResponseHeaders().put(Headers.CONTENT_TYPE, &quot;text/html&quot;);</span>
<span class="nc" id="L243">		exchange.getResponseSender().send(html);</span>
<span class="nc" id="L244">	}</span>

	HttpHandler createWelcomePageHandler() {
<span class="nc" id="L247">		return this::serveWelcomePage;</span>
	}

	private void serveWelcomePage(final HttpServerExchange exchange) throws Exception {
<span class="nc" id="L251">		final String html = processTemplate(&quot;/web-templates/layout/root/page_welcome.ftl.html&quot;,</span>
<span class="nc" id="L252">				map(&quot;title&quot;,</span>
						&quot;Welcome&quot;,
						&quot;dashboards&quot;,
<span class="nc" id="L255">						dashboardController.getDashboardIds()</span>
<span class="nc" id="L256">								.stream()</span>
<span class="nc" id="L257">								.map(dashboardController::getDashboard)</span>
<span class="nc" id="L258">								.map(Optional::get)</span>
<span class="nc" id="L259">								.filter(Dashboard::isEnabled)</span>
<span class="nc" id="L260">								.sorted(Comparator.comparing(Dashboard::getTitle, String.CASE_INSENSITIVE_ORDER))</span>
<span class="nc" id="L261">								.collect(Collectors.toList()),</span>
						&quot;showOwnersInWelcomePage&quot;,
<span class="nc" id="L263">						showOwnersInWelcomePage,</span>
						&quot;getOwnerName&quot;,
<span class="nc" id="L265">						(Function&lt;String, String&gt;) dashboardId -&gt; dashboardController.getDashboard(dashboardId)</span>
<span class="nc" id="L266">								.map(d -&gt; d.getOwners().iterator().next())</span>
<span class="nc" id="L267">								.flatMap(authenticator::readPrincipal)</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">								.map(p -&gt; Strings.isNullOrEmpty(p.getName()) ? p.getUsername() : p.getName())</span>
<span class="nc" id="L269">								.orElse(&quot;No owner&quot;),</span>
						&quot;getOwnerMail&quot;,
<span class="nc" id="L271">						(Function&lt;String, String&gt;) dashboardId -&gt; dashboardController.getDashboard(dashboardId)</span>
<span class="nc" id="L272">								.map(d -&gt; d.getOwners().iterator().next())</span>
<span class="nc" id="L273">								.flatMap(authenticator::readPrincipal)</span>
<span class="nc" id="L274">								.map(com.hlag.oversigt.security.Principal::getEmail)</span>
<span class="nc" id="L275">								.orElse(null)));</span>

<span class="nc" id="L277">		exchange.getResponseHeaders().put(Headers.CONTENT_TYPE, &quot;text/html&quot;);</span>
<span class="nc" id="L278">		exchange.getResponseSender().send(html);</span>
<span class="nc" id="L279">	}</span>

	private String processTemplate(final String templateName, final Map&lt;String, Object&gt; model)
			throws IOException, TemplateException {
<span class="nc" id="L283">		final StringWriter out = new StringWriter();</span>
<span class="nc" id="L284">		templateConfiguration.getTemplate(templateName).process(model, out);</span>
<span class="nc" id="L285">		return out.toString();</span>
	}

	HttpHandler createJsonSchemaHandler() {
<span class="nc" id="L289">		return this::serveJsonSchema;</span>
	}

	private void serveJsonSchema(final HttpServerExchange exchange) {
<span class="nc" id="L293">		final Optional&lt;String&gt; jsonSchema = Optional.ofNullable(exchange.getQueryParameters().get(&quot;class&quot;).poll())</span>
<span class="nc" id="L294">				.flatMap(TypeUtils::getClassForName)</span>
<span class="nc" id="L295">				.filter(SerializableProperty.class::isAssignableFrom)</span>
<span class="nc" id="L296">				.map(JsonUtils::toJsonSchema);</span>

<span class="nc bnc" id="L298" title="All 2 branches missed.">		if (jsonSchema.isPresent()) {</span>
<span class="nc" id="L299">			exchange.setStatusCode(StatusCodes.OK);</span>
<span class="nc" id="L300">			exchange.getResponseHeaders().put(Headers.CONTENT_TYPE, &quot;application/json&quot;);</span>
<span class="nc" id="L301">			exchange.getResponseSender().send(ByteBuffer.wrap(jsonSchema.get().getBytes(StandardCharsets.UTF_8)));</span>
		} else {
<span class="nc" id="L303">			HttpUtils.notFound(exchange);</span>
		}
<span class="nc" id="L305">	}</span>

	HttpHandler createWidgetHandler() {
<span class="nc" id="L308">		return this::serveWidget;</span>
	}

	private void serveWidget(final HttpServerExchange exchange) {
<span class="nc" id="L312">		exchange.setStatusCode(StatusCodes.SEE_OTHER);</span>
<span class="nc" id="L313">		final String widgetName = exchange.getQueryParameters().get(&quot;widget&quot;).getFirst();</span>
<span class="nc" id="L314">		exchange.getResponseHeaders()</span>
<span class="nc" id="L315">				.put(Headers.LOCATION, &quot;/assets/widgets/&quot; + substringBefore(widgetName, &quot;.html&quot;) + &quot;/&quot; + widgetName);</span>
<span class="nc" id="L316">		exchange.endExchange();</span>
<span class="nc" id="L317">	}</span>

	HttpHandler createForeignEventHandler() {
<span class="nc" id="L320">		HttpHandler handler = new BlockingHandler(this::handleForeignEvents);</span>
<span class="nc bnc" id="L321" title="All 2 branches missed.">		if (foreignEventsNeedAuthentication) {</span>
<span class="nc" id="L322">			handler = addBasicAuthentication(handler, identityManager);</span>
		}
<span class="nc bnc" id="L324" title="All 2 branches missed.">		if (!foreignEventsAllowedApiKeys.isEmpty()) {</span>
<span class="nc" id="L325">			handler = addApiKeyAuthentication(handler,</span>
					foreignEventsApiKeyHeaderName,
					foreignEventsAllowedApiKeys::contains);
		}
<span class="nc" id="L329">		return handler;</span>
	}

	@SuppressWarnings(&quot;unchecked&quot;)
	private void handleForeignEvents(final HttpServerExchange exchange) throws IOException {
		// identify principal
<span class="nc" id="L335">		final String name = Optional.of(exchange)</span>
<span class="nc" id="L336">				.map(HttpServerExchange::getSecurityContext)</span>
<span class="nc" id="L337">				.map(SecurityContext::getAuthenticatedAccount)</span>
<span class="nc" id="L338">				.map(Account::getPrincipal)</span>
<span class="nc" id="L339">				.map(Principal::getName)</span>
<span class="nc" id="L340">				.orElse(&quot;&lt;unknown&gt;&quot;);</span>
<span class="nc" id="L341">		LOGGER.info(&quot;Incoming foreign event. From: &quot; + name);</span>

		// read JSON
<span class="nc" id="L344">		final String encoding = exchange.getRequestCharset();</span>
<span class="nc" id="L345">		final Charset charset = Charset.forName(encoding);</span>
<span class="nc" id="L346">		final String json = IOUtils.toString(exchange.getInputStream(), charset);</span>
<span class="nc" id="L347">		LOGGER.trace(&quot;JSON from outside: &quot; + json);</span>
		final Map&lt;String, Object&gt; jsonMap;

		// parse JSON
		try {
<span class="nc" id="L352">			jsonMap = Objects.requireNonNull(JsonUtils.fromJson(json, Map.class));</span>
<span class="nc" id="L353">		} catch (final Exception e) {</span>
<span class="nc" id="L354">			LOGGER.error(&quot;Unable to parse JSON for foreign event: &quot; + json, e);</span>
<span class="nc" id="L355">			HttpUtils.badRequest(exchange);</span>
<span class="nc" id="L356">			return;</span>
<span class="nc" id="L357">		}</span>

		// check JSON
<span class="nc bnc" id="L360" title="All 2 branches missed.">		if (!jsonMap.containsKey(&quot;id&quot;)) {</span>
<span class="nc" id="L361">			LOGGER.warn(&quot;Request does not contain an ID.&quot;);</span>
<span class="nc" id="L362">			HttpUtils.badRequest(exchange);</span>
<span class="nc" id="L363">			return;</span>
		}
<span class="nc" id="L365">		final String id = jsonMap.get(&quot;id&quot;).toString();</span>
		try {
<span class="nc" id="L367">			instanceController.getEventSourceInstance(id);</span>
			// TODO check if JSON fits event definition
<span class="nc" id="L369">		} catch (@SuppressWarnings(&quot;unused&quot;) final NoSuchElementException e) {</span>
<span class="nc" id="L370">			LOGGER.warn(&quot;Event source instance '{}' does not exist.&quot;, id);</span>
<span class="nc" id="L371">			HttpUtils.badRequest(exchange);</span>
<span class="nc" id="L372">			return;</span>
<span class="nc" id="L373">		}</span>

<span class="nc" id="L375">		LOGGER.info(&quot;Posting event for: &quot; + id);</span>
<span class="nc" id="L376">		final JsonEvent event = new JsonEvent(json);</span>
<span class="nc" id="L377">		eventBus.post(event);</span>
<span class="nc" id="L378">		exchange.setStatusCode(StatusCodes.NO_CONTENT);</span>
<span class="nc" id="L379">		exchange.endExchange();</span>
<span class="nc" id="L380">	}</span>

	@SuppressWarnings(&quot;resource&quot;)
	HttpHandler createAssetsHandler() {
<span class="nc" id="L384">		return Handlers.resource(new AssetsClassPathResourceManager(&quot;statics&quot;, widgetsPaths));</span>
	}

	@SuppressWarnings(&quot;resource&quot;)
	HttpHandler createSwaggerUiHandler() {
<span class="nc" id="L389">		return Handlers.resource(new ClassPathResourceManager(&quot;swagger/swagger-ui/3.8.0&quot;));</span>
	}

	HttpHandler createAngularHandler() throws IOException {
<span class="nc" id="L393">		final Path basePath = FileUtils.getPath(OversigtUiHelper.getPathToUiResources().get());</span>
<span class="nc" id="L394">		final Path indexHtml = basePath.resolve(&quot;index.html&quot;);</span>
<span class="nc bnc" id="L395" title="All 4 branches missed.">		if (!Files.exists(indexHtml) || !Files.isRegularFile(indexHtml)) {</span>
<span class="nc" id="L396">			throw new RuntimeException(String.format(&quot;No file called 'index.html' found for Oversigt UI&quot;));</span>
		}

		// find all files belonging to the UI
<span class="nc" id="L400">		final List&lt;String&gt; otherFilesNames = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L401">		final Path parent = indexHtml.getParent();</span>
<span class="nc" id="L402">		try (Stream&lt;Path&gt; paths = Files.list(parent)) {</span>
<span class="nc" id="L403">			otherFilesNames</span>
<span class="nc bnc" id="L404" title="All 2 branches missed.">					.addAll(paths.filter(path -&gt; !Ascii.toLowerCase(path.getFileName().toString()).endsWith(&quot;.txt&quot;))</span>
<span class="nc" id="L405">							.map(path -&gt; path.getFileName().toString())</span>
<span class="nc bnc" id="L406" title="All 2 branches missed.">							.filter(name -&gt; !name.equals(&quot;index.html&quot;))</span>
<span class="nc" id="L407">							.collect(toList()));</span>
		}

<span class="nc" id="L410">		return exchange -&gt; {</span>
			// Find the file to serve
<span class="nc" id="L412">			final String relativePath</span>
<span class="nc bnc" id="L413" title="All 2 branches missed.">					= exchange.getRelativePath().substring(exchange.getRelativePath().startsWith(&quot;/&quot;) ? 1 : 0);</span>
<span class="nc" id="L414">			final Path requestedFile = basePath.resolve(relativePath);</span>
			final Path fileToServe;
<span class="nc bnc" id="L416" title="All 2 branches missed.">			if (Files.isRegularFile(requestedFile)) {</span>
<span class="nc" id="L417">				fileToServe = requestedFile;</span>
			} else {
				// TODO check if it is really the HTML page that should be served...
<span class="nc" id="L420">				fileToServe = basePath.resolve(&quot;index.html&quot;);</span>
			}

			// HTTP/2.0 -&gt; if index.html has been requested -&gt; push other files
<span class="nc bnc" id="L424" title="All 2 branches missed.">			if (fileToServe.getFileName().toString().equals(&quot;index.html&quot;)) {</span>
<span class="nc bnc" id="L425" title="All 2 branches missed.">				for (final String filename : otherFilesNames) {</span>
<span class="nc" id="L426">					exchange.getConnection().pushResource(filename, new HttpString(&quot;GET&quot;), new HeaderMap());</span>
<span class="nc" id="L427">				}</span>
			}

			// actually serve the file
<span class="nc" id="L431">			final String contentType = FileUtils.getExtension(fileToServe).map(extension -&gt; {</span>
<span class="nc bnc" id="L432" title="All 4 branches missed.">				switch (Ascii.toLowerCase(extension)) {</span>
				case &quot;css&quot;:
<span class="nc" id="L434">					return &quot;text/css&quot;;</span>
				case &quot;html&quot;:
<span class="nc" id="L436">					return &quot;text/html&quot;;</span>
				case &quot;js&quot;:
<span class="nc" id="L438">					return &quot;application/javascript&quot;;</span>
				default:
<span class="nc" id="L440">					return &quot;application/octet-stream&quot;;</span>
				}
<span class="nc" id="L442">			}).get();</span>
<span class="nc" id="L443">			exchange.setStatusCode(StatusCodes.OK);</span>
<span class="nc" id="L444">			exchange.getResponseHeaders().put(Headers.CONTENT_TYPE, contentType);</span>
<span class="nc" id="L445">			exchange.getResponseSender().send(ByteBuffer.wrap(Files.readAllBytes(fileToServe)));</span>
<span class="nc" id="L446">			exchange.endExchange();</span>
<span class="nc" id="L447">		};</span>
	}

	/**
	 * Uses Wro4j Filter to pre-process resources Required for coffee scripts
	 * compilation and saas processing Wro4j uses Servlet API so we make fake
	 * Servlet Deployment here to emulate servlet-based environment
	 *
	 * @return Static resources handler
	 */
	HttpHandler createAggregationHandler() throws ServletException {
<span class="nc" id="L458">		final CustomWroConfiguration wroConfig = injector.getInstance(CustomWroConfiguration.class);</span>
<span class="nc" id="L459">		final WroGroupContent content = new WroGroupContent();</span>
<span class="nc" id="L460">		content.addFiltered(FileUtils.streamResourcesFromClasspath(), wroConfig);</span>

<span class="nc" id="L462">		final DeploymentInfo deploymentInfo = Servlets.deployment()</span>
<span class="nc" id="L463">				.setClassLoader(OversigtServer.class.getClassLoader())</span>
<span class="nc" id="L464">				.setContextPath(&quot;/&quot;)</span>
<span class="nc" id="L465">				.setDeploymentName(&quot;oversigt&quot;)</span>
<span class="nc" id="L466">				.addFilterUrlMapping(&quot;wro4j&quot;, &quot;/*&quot;, DispatcherType.REQUEST)</span>
<span class="nc" id="L467">				.addFilter(Servlets.filter(&quot;wro4j&quot;, ConfigurableWroFilter.class, () -&gt; {</span>
<span class="nc" id="L468">					final ConfigurableWroFilter filter = new ConfigurableWroFilter();</span>
<span class="nc" id="L469">					filter.setWroManagerFactory(new WroManagerFactory(content));</span>
<span class="nc" id="L470">					return new ImmediateInstanceHandle&lt;&gt;(filter);</span>
				}));
<span class="nc" id="L472">		final DeploymentManager manager = Servlets.defaultContainer().addDeployment(deploymentInfo);</span>
<span class="nc" id="L473">		manager.deploy();</span>
<span class="nc" id="L474">		return manager.start();</span>
	}

	HttpHandler createApiHandler() throws ServletException {
		// https://github.com/ukarim/undertow-resteasy-example
<span class="nc" id="L479">		final ResteasyDeployment deployment = new ResteasyDeploymentImpl();</span>
<span class="nc" id="L480">		deployment.setApplication(restApiApplication);</span>
<span class="nc" id="L481">		deployment.setInjectorFactoryClass(CdiInjectorFactory.class.getName());</span>
<span class="nc" id="L482">		final DeploymentInfo deploymentInfo = createUndertowDeployment(deployment, &quot;/&quot;);</span>
<span class="nc" id="L483">		deploymentInfo.setClassLoader(OversigtServer.class.getClassLoader());</span>
<span class="nc" id="L484">		deploymentInfo.setDeploymentName(&quot;oversigt-api&quot;);</span>
<span class="nc" id="L485">		deploymentInfo.setContextPath(MAPPING_API);</span>
<span class="nc" id="L486">		deploymentInfo.addListener(listener(org.jboss.weld.environment.servlet.Listener.class));</span>
<span class="nc" id="L487">		deploymentInfo</span>
<span class="nc" id="L488">				.addListener(listener(ApiBootstrapListener.class, createInstanceFactory(ApiBootstrapListener.class)));</span>

<span class="nc" id="L490">		final DeploymentManager manager = defaultContainer().addDeployment(deploymentInfo);</span>
<span class="nc" id="L491">		manager.deploy();</span>
<span class="nc" id="L492">		return manager.start();</span>
	}

	private DeploymentInfo createUndertowDeployment(final ResteasyDeployment deployment, final String mapping) {
<span class="nc" id="L496">		String mappingString = Nullables.orElse(mapping, &quot;/&quot;);</span>
<span class="nc bnc" id="L497" title="All 2 branches missed.">		if (!mappingString.startsWith(&quot;/&quot;)) {</span>
<span class="nc" id="L498">			mappingString = &quot;/&quot; + mappingString;</span>
		}
<span class="nc bnc" id="L500" title="All 2 branches missed.">		if (!mappingString.endsWith(&quot;/&quot;)) {</span>
<span class="nc" id="L501">			mappingString += &quot;/&quot;;</span>
		}
<span class="nc" id="L503">		mappingString = mappingString + &quot;*&quot;;</span>
<span class="nc" id="L504">		String prefix = null;</span>
<span class="nc bnc" id="L505" title="All 2 branches missed.">		if (!mappingString.equals(&quot;/*&quot;)) {</span>
<span class="nc" id="L506">			prefix = mappingString.substring(0, mappingString.length() - 2);</span>
		}
<span class="nc" id="L508">		final ServletInfo resteasyServlet</span>
<span class="nc" id="L509">				= servlet(&quot;ResteasyServlet&quot;, HttpServlet30Dispatcher.class).setAsyncSupported(true)</span>
<span class="nc" id="L510">						.setLoadOnStartup(1)</span>
<span class="nc" id="L511">						.addMapping(mappingString);</span>
<span class="nc bnc" id="L512" title="All 2 branches missed.">		if (prefix != null) {</span>
<span class="nc" id="L513">			resteasyServlet.addInitParam(&quot;resteasy.servlet.mapping.prefix&quot;, prefix);</span>
		}

<span class="nc" id="L516">		return new DeploymentInfo().addServletContextAttribute(ResteasyDeployment.class.getName(), deployment)</span>
<span class="nc" id="L517">				.addServlet(resteasyServlet);</span>
	}

	private &lt;T&gt; InstanceFactory&lt;T&gt; createInstanceFactory(final Class&lt;T&gt; clazz) {
<span class="nc" id="L521">		final Injector injector = this.injector.createChildInjector(binder -&gt; binder.bind(clazz));</span>
<span class="nc" id="L522">		return () -&gt; new ImmediateInstanceHandle&lt;&gt;(injector.getInstance(clazz));</span>
	}

	private static HttpHandler addBasicAuthentication(final HttpHandler next, final IdentityManager identityManager) {
<span class="nc" id="L526">		HttpHandler handler = next;</span>
<span class="nc" id="L527">		handler = new AuthenticationCallHandler(handler);</span>
<span class="nc" id="L528">		handler = new AuthenticationConstraintHandler(handler);</span>
<span class="nc" id="L529">		final List&lt;AuthenticationMechanism&gt; mechanisms</span>
<span class="nc" id="L530">				= Collections.singletonList(new BasicAuthenticationMechanism(&quot;Oversigt&quot;));</span>
<span class="nc" id="L531">		handler = new AuthenticationMechanismsHandler(handler, mechanisms);</span>
<span class="nc" id="L532">		handler = new SecurityInitialHandler(AuthenticationMode.PRO_ACTIVE, identityManager, handler);</span>
<span class="nc" id="L533">		return handler;</span>
	}

	private static HttpHandler addApiKeyAuthentication(final HttpHandler next,
			final String apiKeyHeaderName,
			final Predicate&lt;String&gt; isApiKeyValid) {
<span class="nc" id="L539">		return exchange -&gt; {</span>
<span class="nc" id="L540">			final boolean apiKeyOk = Optional.of(exchange)</span>
<span class="nc" id="L541">					.map(HttpServerExchange::getRequestHeaders)</span>
<span class="nc" id="L542">					.map(hm -&gt; hm.get(apiKeyHeaderName))</span>
<span class="nc" id="L543">					.map(HeaderValues::stream)</span>
<span class="nc" id="L544">					.orElse(Stream.empty())</span>
<span class="nc" id="L545">					.anyMatch(isApiKeyValid);</span>
<span class="nc bnc" id="L546" title="All 2 branches missed.">			if (!apiKeyOk) {</span>
<span class="nc" id="L547">				HttpUtils.forbidden(exchange);</span>
<span class="nc" id="L548">				return;</span>
			}
<span class="nc" id="L550">			next.handleRequest(exchange);</span>
<span class="nc" id="L551">		};</span>
	}

	private static final class AssetsClassPathResourceManager extends ClassPathResourceManager {
		private final String[] widgetsPaths;

		private AssetsClassPathResourceManager(final String prefix, final String[] widgetsPaths) {
<span class="nc" id="L558">			super(prefix);</span>
<span class="nc" id="L559">			this.widgetsPaths = widgetsPaths;</span>
<span class="nc" id="L560">		}</span>

		@Override
		protected URL getResourceUrl(final String realPath) throws IllegalArgumentException {
<span class="nc bnc" id="L564" title="All 2 branches missed.">			if (realPath.startsWith(&quot;statics/widgets/&quot;)) {</span>
<span class="nc" id="L565">				final String end = realPath.substring(&quot;statics/widgets/&quot;.length());</span>
<span class="nc" id="L566">				return Arrays.stream(widgetsPaths)</span>
<span class="nc" id="L567">						.map(s -&gt; s + end)</span>
<span class="nc" id="L568">						.map(FileUtils::getResourceUrl)</span>
<span class="nc" id="L569">						.filter(Optional::isPresent)</span>
<span class="nc" id="L570">						.map(Optional::get)</span>
<span class="nc" id="L571">						.findFirst()</span>
<span class="nc" id="L572">						.orElseThrow(() -&gt; new IllegalArgumentException(&quot;Resource &quot; + realPath + &quot; cannot be found.&quot;));</span>
			}
<span class="nc" id="L574">			return super.getResourceUrl(realPath);</span>
		}
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>