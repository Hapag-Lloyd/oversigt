<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Utils.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Oversigt Core</a> &gt; <a href="index.source.html" class="el_package">com.hlag.oversigt.util</a> &gt; <span class="el_source">Utils.java</span></div><h1>Utils.java</h1><pre class="source lang-java linenums">package com.hlag.oversigt.util;

import static java.util.Objects.requireNonNull;
import static java.util.function.Function.identity;

import java.time.Duration;
import java.util.Arrays;
import java.util.Collection;
import java.util.Collections;
import java.util.Comparator;
import java.util.LinkedHashMap;
import java.util.Map;
import java.util.Objects;
import java.util.Set;
import java.util.TreeSet;
import java.util.function.Function;
import java.util.function.Predicate;
import java.util.function.Supplier;
import java.util.regex.Matcher;
import java.util.regex.Pattern;
import java.util.stream.Collector;
import java.util.stream.Collectors;
import java.util.stream.Stream;
import java.util.stream.Stream.Builder;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.BeanUtils;

import com.google.common.base.CaseFormat;
import com.hlag.oversigt.security.Principal;

import de.larssh.utils.Nullables;
import edu.umd.cs.findbugs.annotations.Nullable;

public final class Utils {
<span class="fc" id="L37">	private static final Logger CHANGE_LOGGER = LoggerFactory.getLogger(&quot;change&quot;);</span>

	public static void logDebug(final Logger logger, final String format, final Object... objects) {
<span class="nc bnc" id="L40" title="All 2 branches missed.">		if (logger.isDebugEnabled()) {</span>
<span class="nc" id="L41">			logger.debug(format(format, objects));</span>
		}
<span class="nc" id="L43">	}</span>

	public static void logTrace(final Logger logger, final String format, final Object... objects) {
<span class="nc bnc" id="L46" title="All 2 branches missed.">		if (logger.isTraceEnabled()) {</span>
<span class="nc" id="L47">			logger.trace(format(format, objects));</span>
		}
<span class="nc" id="L49">	}</span>

	public static void logWarn(final Logger logger, final String format, final Object... objects) {
<span class="nc bnc" id="L52" title="All 2 branches missed.">		if (logger.isWarnEnabled()) {</span>
<span class="nc" id="L53">			logger.warn(format(format, objects));</span>
		}
<span class="nc" id="L55">	}</span>

	public static void logInfo(final Logger logger, final String format, final Object... objects) {
<span class="nc bnc" id="L58" title="All 2 branches missed.">		if (logger.isInfoEnabled()) {</span>
<span class="nc" id="L59">			logger.info(format(format, objects));</span>
		}
<span class="nc" id="L61">	}</span>

	public static void logError(final Logger logger, final String format, final Object... objects) {
<span class="nc bnc" id="L64" title="All 2 branches missed.">		if (logger.isErrorEnabled()) {</span>
<span class="nc" id="L65">			logger.error(format(format, objects));</span>
		}
<span class="nc" id="L67">	}</span>

	public static void logChange(final Principal who, final String didWhat, final Object... withWhat) {
<span class="nc" id="L70">		logChange(who.getUsername(), didWhat, withWhat);</span>
<span class="nc" id="L71">	}</span>

	public static void logChange(final String who, final String didWhat, final Object... withWhat) {
<span class="nc" id="L74">		CHANGE_LOGGER.info(who + &quot; - &quot; + String.format(didWhat, withWhat));</span>
<span class="nc" id="L75">	}</span>

	private static String format(final String string, final Object... objects) {
<span class="nc" id="L78">		return String.format(string,</span>
<span class="nc" id="L79">				Nullables.map(objects,</span>
<span class="nc" id="L80">						objs -&gt; Arrays.stream(objs)</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">								.map(o -&gt; o instanceof Supplier ? ((Supplier&lt;?&gt;) o).get() : o)</span>
<span class="nc" id="L82">								.collect(Collectors.toList())</span>
<span class="nc" id="L83">								.toArray()));</span>
	}

	public static Set&lt;String&gt; findGets(final Collection&lt;String&gt; lines) {
<span class="nc" id="L87">		return findPattern(GET_PATTERN, lines.stream());</span>
	}

	public static Set&lt;String&gt; findSets(final Collection&lt;String&gt; lines) {
<span class="nc" id="L91">		return findPattern(SET_PATTERN, lines.stream());</span>
	}

	public static Set&lt;String&gt; findDataBindings(final Stream&lt;String&gt; lines) {
<span class="nc" id="L95">		return findPattern(DB_PATTERN, lines);</span>
	}

	private static Set&lt;String&gt; findPattern(final Pattern pattern, final Stream&lt;String&gt; lines) {
<span class="nc" id="L99">		return lines.flatMap(s -&gt; find(pattern, s, &quot;name&quot;))</span>
<span class="nc" id="L100">				.map(s -&gt; CaseFormat.LOWER_CAMEL.to(CaseFormat.LOWER_HYPHEN, s))</span>
<span class="nc" id="L101">				.collect(Collectors.toSet());</span>
	}

<span class="fc" id="L104">	private static final Pattern GET_PATTERN = Pattern.compile(&quot;@get\\s*\\(\\s*(['\&quot;])(?&lt;name&gt;[^'\&quot;]+)\\1\\s*\\)&quot;);</span>

<span class="fc" id="L106">	private static final Pattern SET_PATTERN = Pattern.compile(&quot;@set\\s*\\(\\s*(['\&quot;])(?&lt;name&gt;[^'\&quot;]+)\\1\\s*,&quot;);</span>

<span class="fc" id="L108">	private static final Pattern DB_PATTERN = Pattern</span>
<span class="fc" id="L109">			.compile(&quot;data-bind(?:-[-_a-zA-Z0-9]+)?=\&quot;(?&lt;name&gt;[-_a-zA-Z0-9]*+)(\&quot;|[^\&quot;\\.][^\&quot;]*|[^\&quot;\\.]*)\&quot;&quot;);</span>

	private static Stream&lt;String&gt; find(final Pattern pattern, final String line, final String groupName) {
<span class="nc" id="L112">		final Builder&lt;String&gt; builder = Stream.builder();</span>
<span class="nc" id="L113">		final Matcher matcher = pattern.matcher(line);</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">		while (matcher.find()) {</span>
<span class="nc" id="L115">			builder.accept(matcher.group(groupName));</span>
		}
<span class="nc" id="L117">		return builder.build();</span>
	}

	public static &lt;I, T extends Comparable&lt;T&gt;&gt; Comparator&lt;I&gt; caseSensitiveComparator(final Function&lt;I, T&gt; function) {
<span class="nc" id="L121">		return (a, b) -&gt; function.apply(a).compareTo(function.apply(b));</span>
	}

	public static &lt;T&gt; Comparator&lt;T&gt; caseInsensitiveComparator(final Function&lt;T, String&gt; function) {
<span class="nc" id="L125">		return (a, b) -&gt; String.CASE_INSENSITIVE_ORDER.compare(function.apply(a), function.apply(b));</span>
	}

	public static &lt;T&gt; Predicate&lt;T&gt; not(final Predicate&lt;T&gt; predicate) {
<span class="nc bnc" id="L129" title="All 2 branches missed.">		return x -&gt; !predicate.test(x);</span>
	}

	public static &lt;T&gt; Predicate&lt;T&gt; notNull() {
<span class="nc bnc" id="L133" title="All 2 branches missed.">		return x -&gt; x != null;</span>
	}

	public static boolean is(final Object object) {
<span class="nc bnc" id="L137" title="All 2 branches missed.">		if (object instanceof Boolean) {</span>
<span class="nc" id="L138">			return (Boolean) object;</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">		} else if (object instanceof Number) {</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">			return ((Number) object).intValue() &gt; 0;</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">		} else if (object instanceof String) {</span>
<span class="nc" id="L142">			return Boolean.parseBoolean((String) object);</span>
		} else {
<span class="nc" id="L144">			throw new RuntimeException(&quot;Unknown class: &quot; + object.getClass().getName());</span>
		}
	}

	@SafeVarargs
	public static &lt;T&gt; Stream&lt;T&gt; concat(final Stream&lt;T&gt;... streams) {
<span class="nc" id="L150">		return Arrays.stream(streams).flatMap(identity());</span>
	}

	public static String formatDuration(final Duration duration) {
		// https://stackoverflow.com/questions/266825/how-to-format-a-duration-in-java-e-g-format-hmmss
<span class="nc" id="L155">		final long seconds = duration.getSeconds();</span>
<span class="nc" id="L156">		final long absSeconds = Math.abs(seconds);</span>
<span class="nc" id="L157">		final String positive</span>
<span class="nc" id="L158">				= String.format(&quot;%d:%02d:%02d&quot;, absSeconds / 3600, absSeconds % 3600 / 60, absSeconds % 60);</span>
<span class="nc bnc" id="L159" title="All 2 branches missed.">		return seconds &lt; 0 ? &quot;-&quot; + positive : positive;</span>
	}

	public static Map&lt;String, Object&gt; map(final Object... parameters) {
<span class="pc bpc" id="L163" title="1 of 2 branches missed.">		if (parameters.length % 2 != 0) {</span>
<span class="nc" id="L164">			throw new RuntimeException(&quot;keysAndValues length is not even&quot;);</span>
		}
<span class="fc" id="L166">		final Map&lt;String, Object&gt; values = new LinkedHashMap&lt;&gt;();</span>
<span class="fc bfc" id="L167" title="All 2 branches covered.">		for (int i = 0; i &lt; parameters.length; i += 2) {</span>
<span class="pc bpc" id="L168" title="1 of 2 branches missed.">			if (parameters[i] instanceof String) {</span>
<span class="fc" id="L169">				values.put((String) parameters[i], parameters[i + 1]);</span>
			} else {
<span class="nc bnc" id="L171" title="All 2 branches missed.">				throw new ClassCastException(&quot;Unable to convert array to map. Parameter &quot;</span>
						+ i
						+ &quot; (&quot;
<span class="nc" id="L174">						+ (parameters[i] != null ? parameters[i].toString() : &quot;null&quot;)</span>
						+ &quot;) is not of type String.&quot;);
			}
		}
<span class="fc" id="L178">		return values;</span>
	}

	public static Set&lt;String&gt; sortedAndSynchronizedSet(final String... items) {
<span class="nc" id="L182">		return sortedAndSynchronizedSet(Arrays.asList(items));</span>
	}

	public static Set&lt;String&gt; sortedAndSynchronizedSet(final Collection&lt;String&gt; items) {
<span class="nc" id="L186">		final Set&lt;String&gt; set = new TreeSet&lt;&gt;(String.CASE_INSENSITIVE_ORDER);</span>
<span class="nc" id="L187">		set.addAll(items);</span>
<span class="nc" id="L188">		return Collections.synchronizedSet(set);</span>
	}

	public static String notNullOrEmpty(@Nullable final String stringToCheck, final String errorMessage) {
<span class="nc bnc" id="L192" title="All 2 branches missed.">		if (requireNonNull(stringToCheck, errorMessage).isEmpty()) {</span>
<span class="nc" id="L193">			throw new IllegalArgumentException(errorMessage);</span>
		}
<span class="nc" id="L195">		return stringToCheck;</span>
	}

	public static int computeHashCode(final Object... objects) {
<span class="nc" id="L199">		return Stream.of(objects) //</span>
<span class="nc" id="L200">				.filter(notNull())</span>
<span class="nc" id="L201">				.map(Object::hashCode)</span>
<span class="nc" id="L202">				.collect(hashing());</span>
	}

	public static void sleep(final long millis) {
		try {
<span class="nc" id="L207">			Thread.sleep(millis);</span>
<span class="nc" id="L208">		} catch (final InterruptedException e) {</span>
<span class="nc" id="L209">			throw new RuntimeException(&quot;Cannot sleep anymore&quot;, e);</span>
<span class="nc" id="L210">		}</span>
<span class="nc" id="L211">	}</span>

	/**
	 * Collector that allows parallelized calculation of a jobs hash code based upon
	 * {@link Objects#hashCode()}.
	 *
	 * @param &lt;T&gt; the type of input elements to the reduction operation
	 * @return collector that allows parallelized calculation of a jobs hash code
	 * @see &lt;a href=&quot;https://stackoverflow.com/questions/39385860&quot;&gt;StackOverflow&lt;/a&gt;
	 */
	private static &lt;T&gt; Collector&lt;T, ?, Integer&gt; hashing() {
<span class="nc" id="L222">		return Collector.of(() -&gt; new int[2], (a, o) -&gt; {</span>
<span class="nc" id="L223">			a[0] = a[0] * 31 + Objects.hashCode(o);</span>
<span class="nc" id="L224">			a[1] += 1;</span>
<span class="nc" id="L225">		}, (a1, a2) -&gt; {</span>
<span class="nc" id="L226">			a1[0] = a1[0] * iPow(31, a2[1]) + a2[0];</span>
<span class="nc" id="L227">			a1[1] += a2[1];</span>
<span class="nc" id="L228">			return a1;</span>
<span class="nc" id="L229">		}, a -&gt; iPow(31, a[1]) + a[0]);</span>
	}

	/**
	 * @see derived from
	 *      &lt;a href=&quot;http://stackoverflow.com/questions/101439&quot;&gt;StackOverflow&lt;/a&gt;
	 */
	@SuppressWarnings(&quot;all&quot;)
	private static int iPow(int base, int exp) {
<span class="nc" id="L238">		int result = 1;</span>
<span class="nc bnc" id="L239" title="All 2 branches missed.">		for (; exp &gt; 0; exp &gt;&gt;= 1, base *= base) {</span>
<span class="nc bnc" id="L240" title="All 2 branches missed.">			if ((exp &amp; 1) != 0) {</span>
<span class="nc" id="L241">				result *= base;</span>
			}
		}
<span class="nc" id="L244">		return result;</span>
	}

	public static &lt;T&gt; void copyProperties(final T source, final T target, final String... ignoreProperties) {
<span class="nc" id="L248">		BeanUtils.copyProperties(source, target, ignoreProperties);</span>
<span class="nc" id="L249">	}</span>

<span class="nc" id="L251">	private Utils() {</span>
<span class="nc" id="L252">		throw new UnsupportedOperationException();</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>